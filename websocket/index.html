<h1>messaging</h1>
<pre id="messages" style="height: 400px; overflow: scroll"></pre>
<input type="text" id="messageBox" placeholder="type message here" style="display: block; width: 100%; margin-bottom: 10px; padding: 10px;"/> 
<button id="send" title="send message" style="width: 100%; height: 30px;">send message</button>

<script>
    (function () {
        const sendButton = document.querySelector('#send')
        const messages = document.querySelector('#messages')
        const messageBox = document.querySelector('#messageBox')

        let ws;
        function showMessage(message) {
            console.log(message)
            messages.textContent += `\n\n${message}`
            messages.scrollTop = messages.scrollHeight
            messageBox.value = ''
        }

        function init() {
            if (ws) {
                ws.onerror = ws.open = ws.onclose = null
                ws.close()
            }

            ws = new WebSocket('ws://localhost:8080')
            ws.openopen = () => {
                console.log('connection opened')
            }

            ws.onmessage = ({data}) => data.text().then((value) => showMessage(value))
            ws.onclose = function() {
                ws = null
            }

            sendButton.onclick = function() {
                if (!ws) {
                    showMessage("no websocket connection")
                    return
                }

                ws.send(messageBox.value)
                showMessage(messageBox.value)
            }
        }

        init()
    })();
</script>
